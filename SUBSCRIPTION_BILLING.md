# üí∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è –∞–±–æ–Ω–µ–Ω—Ç—Å–∫–æ–π –ø–ª–∞—Ç—ã

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π –∞–±–æ–Ω–µ–Ω—Ç—Å–∫–æ–π –ø–ª–∞—Ç—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—É–º–º —Å –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏ —Å–≤—è–∑–∏. –≠—Ç–æ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤ netspire-go, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ —Å—Ç–∞—Ä–æ–π Erlang —Å–∏—Å—Ç–µ–º–µ.

## üÜö –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–æ–π

### **–°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (Erlang):**
- ‚ùå **–ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π** - —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- ‚ùå **–ù–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞** –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π  
- ‚ùå **–ù–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏** –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ë–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ `debit_transaction()`
- ‚úÖ –ü–ª–∞–Ω –¥–∞–Ω–Ω—ã–µ (plan_data) –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ

### **–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (Go):**
- ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ** –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Å–ø–∏—Å–∞–Ω–∏—è
- ‚úÖ **–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫** —Å –≥–∏–±–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π
- ‚úÖ **–ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ** –¥–ª—è –Ω–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- ‚úÖ **–û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —á–µ—Ä–µ–∑ API
- ‚úÖ **CLI —É—Ç–∏–ª–∏—Ç—ã** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ö–µ–º–æ–π –ë–î

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### **config.yaml**
```yaml
# Subscription Billing (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è –∞–±–æ–Ω–µ–Ω—Ç—Å–∫–æ–π –ø–ª–∞—Ç—ã)
subscription:
  enabled: true                           # –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è
  default_monthly_fee: 25.0               # –ê–±–æ–Ω–µ–Ω—Ç—Å–∫–∞—è –ø–ª–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  grace_period_days: 3                    # –õ—å–≥–æ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Å—Ä–µ–¥—Å—Ç–≤
  disable_on_insufficient_funds: false    # –û—Ç–∫–ª—é—á–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Å—Ä–µ–¥—Å—Ç–≤
  processing_time: "02:00"                # –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–∏—Å–∞–Ω–∏–π (2:00 AM)
  enable_proration: true                  # –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
  
  # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π
  scheduler:
    enabled: true                         # –í–∫–ª—é—á–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
    run_on_first_day: true               # –ó–∞–ø—É—Å–∫–∞—Ç—å 1 —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
    retry_failed: true                   # –ü–æ–≤—Ç–æ—Ä—è—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
    retry_interval_hours: 24             # –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–∞ –≤ —á–∞—Å–∞—Ö
    max_retries: 3                       # –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫
```

### **Plan Data –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**
–í –ø–æ–ª–µ `plan_data` –∞–∫–∫–∞—É–Ω—Ç–∞ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å:
```json
{
  "MONTHLY_FEE": 30.0,        # –ê–±–æ–Ω–µ–Ω—Ç—Å–∫–∞—è –ø–ª–∞—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
  "SUBSCRIPTION_FEE": 25.0,   # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
  "CREDIT": 10.0,             # –ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç
  "PREPAID": 1024000000       # –ü—Ä–µ–¥–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫
}
```

---

## üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

### **1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
```go
// main.go
func main() {
    // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DB, –ª–æ–≥–≥–µ—Ä–∞ ...
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–¥–ø–∏—Å–æ–∫
    subscriptionConfig := &billing.SubscriptionConfig{
        Enabled:                    true,
        DefaultMonthlyFee:         25.0,
        GracePeriodDays:          3,
        DisableOnInsufficientFunds: false,
        ProcessingTime:           "02:00",
        EnableProration:          true,
    }
    
    subscriptionService := billing.NewSubscriptionService(db, logger, subscriptionConfig)
    
    // –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    processor := billing.NewScheduledProcessor(subscriptionService, logger)
    processor.StartDailyScheduler()
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è API routes
    subscriptionHandler := handlers.NewSubscriptionHandler(subscriptionService, logger)
    subscriptionHandler.RegisterRoutes(router)
    
    // ... –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ ...
}
```

### **2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CLI —É—Ç–∏–ª–∏—Ç—ã**
```bash
# –°–±–æ—Ä–∫–∞ CLI
go build -o subscription-processor ./cmd/subscription-processor

# –ó–∞–ø—É—Å–∫ –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π
./subscription-processor process

# –°–ø–∏—Å–∞–Ω–∏—è –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É
./subscription-processor process 2024-01-01

# –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
./subscription-processor history 123

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
./subscription-processor stats
```

---

## üìä HTTP API

### **–†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∏–π**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏—è –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
POST /api/v1/subscription/process

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏—è –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É
POST /api/v1/subscription/process/2024-01-01
```

### **–ò—Å—Ç–æ—Ä–∏—è –∏ –æ—Ç—á–µ—Ç—ã**
```bash
# –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET /api/v1/subscription/account/123/history?limit=10

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
GET /api/v1/subscription/stats

# –ù–µ—É–¥–∞—á–Ω—ã–µ —Å–ø–∏—Å–∞–Ω–∏—è
GET /api/v1/subscription/failed?limit=20

# –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç
GET /api/v1/subscription/report/2024/01
```

### **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
```bash
# –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∞–Ω–∏—è
GET /api/v1/subscription/preview/123

# –¢–µ—Å—Ç–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
POST /api/v1/subscription/test/123
```

---

## üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü**
–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ö–µ–º–æ–π –ë–î –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:

- **`fin_transactions`** - –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–ø–∏—Å–∞–Ω–∏–π
- **`accounts`** - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ plan_data
- **`contracts`** - –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤
- **`plans`** - –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤

### **–§—É–Ω–∫—Ü–∏–∏ PostgreSQL**
```sql
-- –°–ø–∏—Å–∞–Ω–∏–µ –∞–±–æ–Ω–µ–Ω—Ç—Å–∫–æ–π –ø–ª–∞—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é)
SELECT debit_transaction(account_id, 25.0, 'Monthly subscription fee for period 2024-01-01 - 2024-01-31', NULL);

-- –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π
SELECT * FROM fin_transactions 
WHERE comment LIKE 'Monthly subscription fee%' 
AND created_at >= '2024-01-01' 
AND created_at <= '2024-01-31';
```

---

## üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

### **1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫**
1. **–ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞: 1 —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞?** 
3. **–ï—Å–ª–∏ –¥–∞** ‚Üí –∑–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–∏—Å–∞–Ω–∏–π
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤**
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**

### **2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ plan_data** –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ monthly_fee
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–∂–µ —Å–ø–∏—Å–∞–Ω–Ω–æ–≥–æ** –∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥
3. **–†–∞—Å—á–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å—É–º–º—ã** (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞** (–±–∞–ª–∞–Ω—Å + –∫—Ä–µ–¥–∏—Ç >= —Å—É–º–º–∞)
5. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è** —á–µ—Ä–µ–∑ `debit_transaction()`
6. **–ó–∞–ø–∏—Å—å –≤ –ª–æ–≥–∏** –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### **3. –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ**
```go
// –ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω 15 —è–Ω–≤–∞—Ä—è, –∞ —Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —è–Ω–≤–∞—Ä—å,
// —Ç–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞ –≤—Ç–æ—Ä—É—é –ø–æ–ª–æ–≤–∏–Ω—É –º–µ—Å—è—Ü–∞
totalDays := 31       // –¥–Ω–µ–π –≤ —è–Ω–≤–∞—Ä–µ
remainingDays := 17   // —Å 15 –ø–æ 31 —è–Ω–≤–∞—Ä—è
amount := 25.0 * (17/31) = 13.71  // –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—É–º–º–∞
```

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–õ–æ–≥–∏**
```
2024-01-01 02:00:15 INFO  Starting monthly subscription charges processing target_date=2024-01-01
2024-01-01 02:00:16 INFO  Found accounts for billing count=150
2024-01-01 02:00:17 INFO  Processed account charge account_id=123 login=user123 status=success amount=25.0
2024-01-01 02:00:18 ERROR Failed to process account charge account_id=124 login=user124 error="insufficient funds"
2024-01-01 02:00:25 INFO  Monthly charges processing completed success=145 failures=5 total=150
```

### **–ú–µ—Ç—Ä–∏–∫–∏ —á–µ—Ä–µ–∑ API**
```json
{
  "stats": {
    "total_accounts": 150,
    "active_accounts": 148,
    "charges_this_month": 145,
    "failed_charges": 5,
    "total_revenue": 3625.0,
    "success_rate": 96.7
  }
}
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–æ–≤

### **–ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–Ω –¥–∞–Ω–Ω—ã—Ö**
```json
{
  "MONTHLY_FEE": 30.0,
  "CREDIT": 10.0,
  "PREPAID": 1073741824,
  "INTERVALS": [
    [86400, {"internet": [1, 0.01, 0.015]}]
  ],
  "SHAPER": "1024k",
  "ACCESS_INTERVALS": [
    [86400, "accept", "unlimited"]
  ]
}
```

### **–†–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã —Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏**
1. **–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞–±–æ–Ω–ø–ª–∞—Ç–∞**: `MONTHLY_FEE: 25.0`
2. **–ë–µ–∑ –∞–±–æ–Ω–ø–ª–∞—Ç—ã**: –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å `MONTHLY_FEE` –∏–ª–∏ `0`
3. **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç–∞**: –∑–∞–¥–∞–≤–∞—Ç—å –≤ plan_data –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
4. **–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `default_monthly_fee` –≤ –∫–æ–Ω—Ñ–∏–≥–µ

---

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤**
```json
{
  "account_id": 123,
  "status": "failed",
  "failure_reason": "insufficient_funds",
  "amount": 25.0,
  "balance": 10.0,
  "credit": 5.0
}
```

### **–û–ø—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Å—Ä–µ–¥—Å—Ç–≤**
1. **–û—Å—Ç–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º** (`disable_on_insufficient_funds: false`)
2. **–û—Ç–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç** (`disable_on_insufficient_funds: true`)
3. **–õ—å–≥–æ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥** (`grace_period_days: 3`)

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã

### **–®–∞–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏**
1. **‚úÖ –°—Ö–µ–º–∞ –ë–î –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è** - –ø–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
2. **‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** 
3. **‚úÖ –ë–∞–ª–∞–Ω—Å—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è**
4. **‚úÖ Plan_data —Ñ–æ—Ä–º–∞—Ç –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º**

### **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å MONTHLY_FEE –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–ª–∞–Ω—ã
UPDATE accounts SET plan_data = 
    CASE 
        WHEN plan_data = '' THEN '{"MONTHLY_FEE": 25.0}'
        ELSE plan_data::jsonb || '{"MONTHLY_FEE": 25.0}'::jsonb
    END
WHERE plan_id IN (1, 2, 3);  -- ID —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ —Å –∞–±–æ–Ω–ø–ª–∞—Ç–æ–π
```

---

## üìã –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### **1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π**
```bash
# 1. –û–±–Ω–æ–≤–∏—Ç—å config.yaml
subscription:
  enabled: true
  default_monthly_fee: 25.0

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
systemctl restart netspire-go

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f /var/log/netspire-go.log | grep "subscription"
```

### **2. –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–ø–∏—Å–∞–Ω–∏–π**
```bash
# –ß–µ—Ä–µ–∑ CLI
./subscription-processor process 2024-01-01

# –ß–µ—Ä–µ–∑ API
curl -X POST http://localhost:8080/api/v1/subscription/process/2024-01-01
```

### **3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**
```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ CLI
./subscription-processor stats

# –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
./subscription-processor history 123

# –ß–µ—Ä–µ–∑ API
curl http://localhost:8080/api/v1/subscription/stats
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –¥–∞—Ç–∞–º–∏ –ø–µ—Ä–∏–æ–¥–∞
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π –≤ PostgreSQL

### **–ê—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π**
- ‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `fin_transactions` —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
- ‚úÖ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–ø–∏—Å–∞–Ω–∏–π

### **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ netspire-go –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- **100% —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- **–ü—Ä–æ—Å—Ç—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É** —á–µ—Ä–µ–∑ config.yaml
- **–ì–∏–±–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** —á–µ—Ä–µ–∑ API –∏ CLI
- **–î–µ—Ç–∞–ª—å–Ω—É—é –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å** –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **–ù–∞–¥–µ–∂–Ω—É—é —Ä–∞–±–æ—Ç—É** —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –ª–æ–≥–∞–º —Å–∏—Å—Ç–µ–º—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API. 